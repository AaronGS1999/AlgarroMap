<!DOCTYPE html>
<html>
<head>
    <title>Mapa Interactivo con JSON</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #mapid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .popup-content {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 95vw;
            height: 95vh;
            overflow: auto;
            box-sizing: border-box;
            padding: 10px;
        }

        .popup-img-container {
            width: 100%;
            height: 60vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 10px;
            border-radius: 8px;
        }

        .popup-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .popup-text {
            font-size: 1rem;
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            overflow-wrap: break-word;
        }

        @media (max-width: 600px) {
            .popup-text {
                font-size: 0.9rem;
            }
        }

        @media (max-width: 400px) {
            .popup-text {
                font-size: 0.8rem;
            }
        }

        /* Leaflet popup ajustes */
        .leaflet-popup-content-wrapper {
            padding: 0 !important;
            border-radius: 8px;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            width: 100% !important;
            height: 100% !important;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .leaflet-popup-tip-container {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="mapid"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script>
        function cargarJSON(url, callback) {
            fetch(url)
                .then(response => response.json())
                .then(data => callback(data))
                .catch(error => console.error('Error cargando JSON:', error));
        }

        const mymap = L.map('mapid').setView([36.93, -1.99], 13);

        L.tileLayer('https://tile.opentopomap.org/{z}/{x}/{y}.png', {
            maxZoom: 17,
            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                         '<a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; ' +
                         '<a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
        }).addTo(mymap);

        function getColor(sexo) {
            if (sexo && sexo.toLowerCase() === 'macho') return 'blue';
            if (sexo && sexo.toLowerCase() === 'hembra') return 'red';
            return 'gray';
        }

        function getTreeIcon(color) {
            const svg = `
                <svg width="30" height="30" viewBox="0 0 24 24" fill="${color}" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C10.343 2 9 3.343 9 5C9 5.798 9.312 6.519 9.824 7.071C8.417 7.482 7.367 8.7 7.051 10.18C6.439 10.067 5.782 10.177 5.231 10.521C4.264 11.128 4.079 12.443 4.936 13.206C5.278 13.513 5.715 13.683 6.17 13.705C6.055 14.323 6.151 14.974 6.447 15.557C6.987 16.6 8.03 17.268 9.176 17.268H11V22H13V17.268H14.824C15.97 17.268 17.013 16.6 17.553 15.557C17.849 14.974 17.945 14.323 17.83 13.705C18.285 13.683 18.722 13.513 19.064 13.206C19.921 12.443 19.736 11.128 18.769 10.521C18.218 10.177 17.561 10.067 16.949 10.18C16.633 8.7 15.583 7.482 14.176 7.071C14.688 6.519 15 5.798 15 5C15 3.343 13.657 2 12 2Z"/>
                </svg>
            `;
            return L.divIcon({
                html: svg,
                className: '',
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30]
            });
        }

        cargarJSON('datos.json', function(puntos) {
            puntos.forEach(punto => {
                const lat = punto.latitud / 1000000;
                const lon = punto.longitud / 1000000;
                const color = getColor(punto.Sexo);
                const treeIcon = getTreeIcon(color);

                const marker = L.marker([lat, lon], {
                    icon: treeIcon
                }).addTo(mymap);

                const img = new Image();
                img.src = `imagenes/${punto.imagen}`;
                img.onload = function () {
                    const popupContent = document.createElement('div');
                    popupContent.className = 'popup-content';

                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'popup-img-container';

                    const imageElement = document.createElement('img');
                    imageElement.src = img.src;
                    imageElement.className = 'popup-img';
                    imageContainer.appendChild(imageElement);

                    const text = document.createElement('div');
                    text.className = 'popup-text';
                    text.innerHTML = `
                        <b>${punto.Nombre}</b><br>
                        Sexo: ${punto.Sexo}<br>
                        Injerto: ${punto["Injerto (Pie)"]}<br>
                        Cultivado: ${punto["Silvestre/Cultivado"]}<br>
                        Fecha de recolección: ${punto["Fecha recolección"]}<br>
                        Observaciones: ${punto.Observaciones || 'Ninguna'}<br>
                    `;

                    popupContent.appendChild(imageContainer);
                    popupContent.appendChild(text);

                    const popup = L.popup({
                        maxWidth: 'auto',
                        maxHeight: 'auto',
                        className: 'custom-popup',
                        autoPan: true
                    }).setContent(popupContent);

                    marker.bindPopup(popup);
                };
            });
        });
    </script>
</body>
</html>
